<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NovelGPT</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
    <div class="container py-5">
        <h1 class="text-center">üìö Ïä§ÌÜ†Î¶¨ Ï†úÏûëÏÜå</h1>

        <!-- Input Section -->
        <div class="card my-4">
            <div class="card-body">
                <!-- <label for="themeInput" class="form-label">Enter the theme or genre of your story:</label> -->
                <input type="text" id="themeInput" class="form-control" placeholder="ÎßåÎì§Í≥† Ïã∂ÏùÄ ÏûêÏã†ÎßåÏùò Ïä§ÌÜ†Î¶¨Ïùò Ï†úÎ™©ÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî...">
                <div class="d-flex justify-content-end mt-3">
                    <button id="clearBtn" class="btn btn-outline-secondary me-2">Ï¥àÍ∏∞Ìôî</button>
                    <button id="startBtn" class="btn btn-primary">ÏãúÏûë</button>
                </div>
            </div>
        </div>

        <!-- Story Section -->
        <div id="storyContainer">
            <!-- Dynamically loaded content -->
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
$(document).ready(function () {
    let storyList = []; // ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏ÏóêÏÑú Ïä§ÌÜ†Î¶¨ Îç∞Ïù¥ÌÑ∞ Í¥ÄÎ¶¨

    // Clear Î≤ÑÌäº ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏
    $('#clearBtn').on('click', function () {
        $('#themeInput').val('').prop('disabled', false);
        storyList = [];
        $('#storyContainer').html('');
    });

    // Start Î≤ÑÌäº ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏
    $('#startBtn').on('click', function () {
        const theme = $('#themeInput').val();
        if (!theme) {
            alert('Please enter a theme or genre.');
            return;
        }
        $('#themeInput').prop('disabled', true);
        sendRequest(theme, '');
    });

    // Continue Î≤ÑÌäº ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏
    $(document).on('click', '#continueBtn', function () {
        const oid = $(this).closest('.card').attr('id').split('-')[1]; // Extract oid from card ID
        const selectedChoice = $(`input[name="choices-${oid}"]:checked`).val(); // Get the selected choice

        if (!selectedChoice) {
            alert('Please select an option.');
            return;
        }

        const lastStory = storyList.find(story => story.oid === oid); // Find the story object
        sendRequest(lastStory.story, selectedChoice); // Send request with the selected choice
    });


    
    // Collapse Î≤ÑÌäº ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏
    $(document).on('click', '.collapse-btn', function () {
        const target = $(this).data('target');
        $(target).collapse('toggle'); // Bootstrap Collapse
        const icon = $(this).find('i');
        icon.toggleClass('fa-chevron-down fa-chevron-up'); // ÌôîÏÇ¥Ìëú ÌÜ†Í∏Ä
    });

    // ÏÇ≠Ï†ú Î≤ÑÌäº ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏
    $(document).on('click', '.delete-btn', function () {
        const oid = $(this).data('oid');

        // ÏÑúÎ≤ÑÏóê ÏÇ≠Ï†ú ÏöîÏ≤≠
        $.ajax({
            url: `/openai/delete_story/${oid}`, // Flask ÏóîÎìúÌè¨Ïù∏Ìä∏
            method: 'DELETE',
            success: function (response) {
                alert(response.message); // ÏÑ±Í≥µ Î©îÏãúÏßÄ ÌëúÏãú
                storyList = storyList.filter(story => story.oid !== oid); // Î¶¨Ïä§Ìä∏ÏóêÏÑú Ï†úÍ±∞
                $(`#story-${oid}`).remove(); // UIÏóêÏÑú Ï†úÍ±∞

                // ÎßàÏßÄÎßâ Ïä§ÌÜ†Î¶¨Ïùò Choice ÌôúÏÑ±Ìôî
                if (storyList.length > 0) {
                    const lastStory = storyList[storyList.length - 1];
                    $(`#story-${lastStory.oid} #continueBtn`).prop('disabled', false);
                    $(`#story-${lastStory.oid} input[name="choices"]`).prop('disabled', false);
                } else {
                    // Î™®Îì† Ïä§ÌÜ†Î¶¨Í∞Ä ÏÇ≠Ï†úÎêú Í≤ΩÏö∞ ÏûÖÎ†• ÌôúÏÑ±Ìôî
                    $('#themeInput').prop('disabled', false);
                }
            },
            error: function (response) {
                alert(response.responseJSON.message); // Ïò§Î•ò Î©îÏãúÏßÄ ÌëúÏãú
            }
        });
    });

    // ÏÑúÎ≤ÑÏóê ÏöîÏ≤≠ÏùÑ Ï†ÑÏÜ°ÌïòÎäî Ìï®Ïàò
    const sendRequest = (genre, userChoice) => {
        $.ajax({
            url: '/openai/generate_story',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ genre, user_choice: userChoice }),
            success: function (response) {
                storyList.push(response); // ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏ ÏÉÅÌÉúÏóê Ï∂îÍ∞Ä
                renderStory(response);

                // Ïù¥Ï†Ñ Ïä§ÌÜ†Î¶¨Ïùò Choice ÎπÑÌôúÏÑ±Ìôî
                if (storyList.length > 1) {
                    const prevStory = storyList[storyList.length - 2];
                    $(`#story-${prevStory.oid} #continueBtn`).prop('disabled', true);
                    $(`#story-${prevStory.oid} input[name="choices"]`).prop('disabled', true);
                }
            },
            error: function () {
                alert('Error generating story.');
            }
        });
    };

    // Ïä§ÌÜ†Î¶¨Î•º Î†åÎçîÎßÅÌïòÎäî Ìï®Ïàò
    const renderStory = (data) => {
        const { oid, story, decisionQuestion, choices, dalle_img } = data;

        const isLast = storyList.length === 0 || storyList[storyList.length - 1].oid === oid;

        const storyHtml = `
        <div class="card mb-4" id="story-${oid}">
            <div class="card-header d-flex justify-content-between align-items-center">
                <button class="btn btn-link collapse-btn" data-bs-toggle="collapse" data-bs-target="#collapse-${oid}">
                    <i class="fa fa-chevron-down"></i>
                </button>
            </div>
            <div class="collapse show" id="collapse-${oid}">
                <div class="card-body">
                    <div class="row align-items-center">
                        <!-- Image Section -->
                        <div class="col-12 col-md-4 text-center">
                            <img src="${dalle_img}" alt="Generated Image" class="img-fluid mb-3">
                        </div>

                        <!-- Text Section -->
                        <div class="col-12 col-md-8">
                            <p>${story}</p>
                            <hr>
                            <p><strong>${decisionQuestion}</strong></p>
                            ${choices.map((choice, index) => `
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="choices-${oid}" id="choice${index}-${oid}" value="${choice}" ${!isLast ? 'disabled' : ''}>
                                    <label class="form-check-label" for="choice${index}-${oid}">
                                        ${choice}
                                    </label>
                                </div>
                            `).join('')}
                            <div class="d-flex justify-content-between mt-3">
                                <button class="btn btn-success" id="continueBtn" ${!isLast ? 'disabled' : ''}>ÏßÑÌñâ</button>
                                <button class="btn btn-danger delete-btn" data-oid="${oid}">ÏÇ≠Ï†ú</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        `;
        $('#storyContainer').append(storyHtml);
};

    // ÏÑúÎ≤ÑÏóêÏÑú Ï†ÄÏû•Îêú Î™®Îì† Ïä§ÌÜ†Î¶¨Î•º Í∞ÄÏ†∏Ïò§Í∏∞
    const loadStories = () => {
        $.ajax({
            url: '/openai/get_stories',
            method: 'GET',
            success: function (response) {
                storyList = response.stories;
                $('#storyContainer').html(''); // Í∏∞Ï°¥ Î†åÎçîÎßÅ Ï¥àÍ∏∞Ìôî
                storyList.forEach(story => renderStory(story));
            },
            error: function () {
                alert('Error loading stories.');
            }
        });
    };

    // ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú Í∏∞Ï°¥ Ïä§ÌÜ†Î¶¨ Î∂àÎü¨Ïò§Í∏∞
    loadStories();
});
    </script>
</body>
</html>
