<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NovelGPT</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
    <div class="container py-5">
        <h1 class="text-center">üìö Ïä§ÌÜ†Î¶¨ Ï†úÏûëÏÜå</h1>

        <!-- Input Section -->
        <div class="card my-4">
            <div class="card-body">
                <input type="text" id="themeInput" class="form-control" placeholder="ÎßåÎì§Í≥† Ïã∂ÏùÄ ÏûêÏã†ÎßåÏùò Ïä§ÌÜ†Î¶¨Ïùò Ï†úÎ™©ÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî...">
                <div class="d-flex justify-content-end mt-3">
                    <button id="clearBtn" class="btn btn-outline-secondary me-2">Ï¥àÍ∏∞Ìôî</button>
                    <button id="startBtn" class="btn btn-primary">ÏãúÏûë</button>
                </div>
            </div>
        </div>

        <!-- Story Section -->
        <div id="storyContainer">
            <!-- Dynamically loaded content -->
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
$(document).ready(function () {
    let storyList = []; // ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏ÏóêÏÑú Ïä§ÌÜ†Î¶¨ Îç∞Ïù¥ÌÑ∞ Í¥ÄÎ¶¨

    // Clear Î≤ÑÌäº ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏
    $('#clearBtn').on('click', function () {
        $('#themeInput').val('').prop('disabled', false);
        storyList = [];
        $('#storyContainer').html('');
    });

    // Start Î≤ÑÌäº ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏
    $('#startBtn').on('click', function () {
        const theme = $('#themeInput').val();
        if (!theme) {
            alert('Please enter a theme or genre.');
            return;
        }
        $('#themeInput').prop('disabled', true);
        sendRequest(theme, '');
    });

    // input ÎÇ¥Ïö© ÌôúÏÑ±Ìôî
    $(document).on('change', 'input[name^="choices-"]', function () {
        // Extract oid dynamically from the input's name attribute
        //const oid = $(this).attr('name').split('-')[1]; // Assumes 'choices-oid' format
        const oid = $(this).attr('name').split('-').slice(1).join('-');
        const customRadio = $(`#custom-choice-${oid}`);
        const customInputContainer = $(`#custom-input-container-${oid}`);
        const customInput = $(`#custom-input-${oid}`);

        if (customRadio.is(':checked')) {
            // Show input field if custom radio is selected
            customInputContainer.show();
        } else {
            // Hide input field and clear value if custom radio is deselected
            customInputContainer.hide();
            customInput.val('');
        }
});


    // // Continue Î≤ÑÌäº ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏
    // $(document).on('click', '#continueBtn', function () {
    //     const oid = $(this).closest('.card').attr('id').split('-').slice(1).join('-');
    //     const selectedChoice = $(`input[name="choices-${oid}"]:checked`).val();
    //     const customInput = $(`#custom-input-${oid}`).val().trim();

    //     if (!selectedChoice && !customInput) {
    //         alert('Please select a choice or write your own answer.');
    //         return;
    //     }

    //     const lastStory = storyList.find(story_en => story_en.oid === oid); // Find the story object
    //     sendRequest(lastStory.story_en, selectedChoice); // Send request with the selected choice
    // });

    // Continue Î≤ÑÌäº ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏
    $(document).on('click', '#continueBtn', function () {
        const oid = $(this).closest('.card').attr('id').split('-').slice(1).join('-');
        const selectedChoice = $(`input[name="choices-${oid}"]:checked`).val();
        const customInput = $(`#custom-input-${oid}`).val().trim();

        // ÏÑ†ÌÉùÏßÄÏôÄ ÏÇ¨Ïö©Ïûê ÏûÖÎ†•Ïù¥ Î™®Îëê ÎπÑÏñ¥ ÏûàÎäî Í≤ΩÏö∞ ÏïåÎ¶º
        if (!selectedChoice && !customInput ) {
            alert('Please select a choice or write your own answer.');
            return;
        } else if (selectedChoice == "custom-input" && !customInput ) {
            alert('Please select a choice or write your own answer.');
            return;
        }
        // Ïö∞ÏÑ† ÏàúÏúÑ: ÏÇ¨Ïö©Ïûê ÏûÖÎ†•Ïù¥ ÏûàÏúºÎ©¥ Ïù¥Î•º ÏÇ¨Ïö©, ÏóÜÏúºÎ©¥ ÏÑ†ÌÉùÏßÄ ÏÇ¨Ïö©
        const userAnswer = customInput || selectedChoice;

        // ÏÑ†ÌÉùÎêú Ïä§ÌÜ†Î¶¨Î•º Ï∞æÏùå
        const lastStory = storyList.find(story => story.oid === oid);

        if (!lastStory) {
            alert('Story not found. Please refresh the page.');
            return;
        }

        console.log(userAnswer);

        // ÏÑúÎ≤Ñ ÏöîÏ≤≠ Ìï®Ïàò Ìò∏Ï∂ú
        sendRequest(lastStory.story_en, userAnswer); // ÏÇ¨Ïö©Ïûê ÏûÖÎ†• ÎòêÎäî ÏÑ†ÌÉùÎêú Í∞íÏùÑ Ï†ÑÎã¨
    });


    // ÏÇ≠Ï†ú Î≤ÑÌäº ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏
    $(document).on('click', '.delete-btn', function () {
        const oid = $(this).data('oid');

        // ÏÑúÎ≤ÑÏóê ÏÇ≠Ï†ú ÏöîÏ≤≠
        $.ajax({
            url: `/openai/delete_story/${oid}`, // Flask ÏóîÎìúÌè¨Ïù∏Ìä∏
            method: 'DELETE',
            success: function (response) {
                alert(response.message); // ÏÑ±Í≥µ Î©îÏãúÏßÄ ÌëúÏãú
                storyList = storyList.filter(story => story.oid !== oid); // Î¶¨Ïä§Ìä∏ÏóêÏÑú Ï†úÍ±∞
                $(`#story-${oid}`).remove(); // UIÏóêÏÑú Ï†úÍ±∞

                // ÎßàÏßÄÎßâ Ïä§ÌÜ†Î¶¨Ïùò Choice ÌôúÏÑ±Ìôî
                if (storyList.length > 0) {
                    const lastStory = storyList[storyList.length - 1];
                    $(`#story-${lastStory.oid} #continueBtn`).prop('disabled', false);
                    $(`#story-${lastStory.oid} input[name="choices"]`).prop('disabled', false);
                } else {
                    // Î™®Îì† Ïä§ÌÜ†Î¶¨Í∞Ä ÏÇ≠Ï†úÎêú Í≤ΩÏö∞ ÏûÖÎ†• ÌôúÏÑ±Ìôî
                    $('#themeInput').prop('disabled', false);
                }

                // Ïù¥Ï†Ñ Ïä§ÌÜ†Î¶¨Ïùò Choice ÎπÑÌôúÏÑ±Ìôî
                if (storyList.length > 0) {
                    const prevStory = storyList[storyList.length - 1];
                    $(`#story-${prevStory.oid} #continueBtn`).prop('disabled', false);
                    $(`#story-${prevStory.oid} input[name="choices"]`).prop('disabled', false);
                }
            },
            error: function (response) {
                alert(response.responseJSON.message); // Ïò§Î•ò Î©îÏãúÏßÄ ÌëúÏãú
            }
        });

        loadStories();
    });

    // ÏÑúÎ≤ÑÏóê ÏöîÏ≤≠ÏùÑ Ï†ÑÏÜ°ÌïòÎäî Ìï®Ïàò
    const sendRequest = (genre, userChoice) => {
        $.ajax({
            url: '/openai/generate_story',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ genre, user_choice: userChoice }),
            success: function (response) {
                storyList.push(response); // ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏ ÏÉÅÌÉúÏóê Ï∂îÍ∞Ä
                renderStory(response);

                // Ïù¥Ï†Ñ Ïä§ÌÜ†Î¶¨Ïùò Choice ÎπÑÌôúÏÑ±Ìôî
                if (storyList.length > 1) {
                    const prevStory = storyList[storyList.length - 2];
                    $(`#story-${prevStory.oid} #continueBtn`).prop('disabled', true);
                    $(`#story-${prevStory.oid} input[name="choices"]`).prop('disabled', true);
                }
            },
            error: function () {
                alert('Error generating story.');
            }
        });
    };

    // Ïä§ÌÜ†Î¶¨Î•º Î†åÎçîÎßÅÌïòÎäî Ìï®Ïàò
    const renderStory = (data) => {
        const { oid, story_en, story_kr, decisionQuestion_en, decisionQuestion_kr, choices_en, choices_kr, dalle_img } = data;

        const isLast = storyList.length === 0 || storyList[storyList.length - 1].oid === oid;

        const storyHtml = `
        <div class="card mb-4" id="story-${oid}">
            <div class="card-header d-flex justify-content-between align-items-center">
                <button class="btn btn-link collapse-btn" data-bs-toggle="collapse" data-bs-target="#collapse-${oid}">
                    <i class="fa fa-chevron-down"></i>
                </button>
            </div>
            <div class="collapse show" id="collapse-${oid}">
                <div class="card-body">
                    <div class="row align-items-center">
                        <!-- Image Section -->
                        <div class="col-12 col-md-4 text-center">
                            <img src="${dalle_img}" alt="Generated Image" class="img-fluid mb-3">
                        </div>

                        <!-- Text Section -->
                        <div class="col-12 col-md-8">
                            <p><strong>Story (English):</strong></p>
                            <p>${story_en}</p>
                            <button class="btn btn-link" data-bs-toggle="collapse" data-bs-target="#story-kr-${oid}">Show Korean Translation</button>
                            <div class="collapse" id="story-kr-${oid}">
                                <p><strong>Story (Korean):</strong></p>
                                <p>${story_kr}</p>
                            </div>
                            <hr>
                            
                            <button class="btn btn-link" data-bs-toggle="collapse" data-bs-target="#question-${oid}">Show Question & Choice</button>
                            <div class="collapse" id="question-${oid}">
                                <p><strong>Question (English):</strong> ${decisionQuestion_en}</p>
                                <div id="choices-en-${oid}">
                                    ${choices_en.map((choice, index) => `
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="choices-${oid}" id="choice-en-${index}-${oid}" value="${choice}" ${!isLast ? 'disabled' : ''}>
                                            <label class="form-check-label" for="choice-en-${index}-${oid}">
                                                ${choice}
                                            </label>
                                        </div>
                                    `).join('')}
                                </div>
    
                               <div class="form-check mt-3">
                                    <label for="custom-input-${oid}" class="form-label">
                                        <input type="radio" class="form-check-input custom-radio" name="choices-${oid}" id="custom-choice-${oid}" value="custom-input" ${!isLast ? 'disabled' : ''}>
                                        <strong>Or write your own answer:</strong>
                                    </label>
                                </div>
                                <div class="mt-2" id="custom-input-container-${oid}" style="display: none;">
                                    <input type="text" class="form-control" id="custom-input-${oid}" placeholder="Write your answer here..." ${!isLast ? 'disabled' : ''}>
                                </div>


                                <button class="btn btn-link" data-bs-toggle="collapse" data-bs-target="#choices-kr-${oid}">Show Korean Question and Choices</button>
                                <div class="collapse" id="choices-kr-${oid}">
                                    <p><strong>Question (Korean):</strong> ${decisionQuestion_kr}</p>
                                    ${choices_kr.map((choice, index) => `
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="choices-${oid}" id="choice-kr-${index}-${oid}" value="${choice}" ${!isLast ? 'disabled' : ''}>
                                            <label class="form-check-label" for="choice-kr-${index}-${oid}">
                                                ${choice}
                                            </label>
                                        </div>
                                    `).join('')}
                                </div>
                           

                            <div class="d-flex justify-content-between mt-3">
                                <button class="btn btn-success" id="continueBtn" ${!isLast ? 'disabled' : ''}>ÏßÑÌñâ</button>
                                <button class="btn btn-danger delete-btn" data-oid="${oid}">ÏÇ≠Ï†ú</button>
                            </div>
                        </div>                       
                      </div>
                    </div>
                </div>
            </div>
        </div>
        `;
        $('#storyContainer').append(storyHtml);
    };

    // ÏÑúÎ≤ÑÏóêÏÑú Ï†ÄÏû•Îêú Î™®Îì† Ïä§ÌÜ†Î¶¨Î•º Í∞ÄÏ†∏Ïò§Í∏∞
    const loadStories = () => {
        $.ajax({
            url: '/openai/get_stories',
            method: 'GET',
            success: function (response) {
                storyList = response.stories;
                $('#storyContainer').html(''); // Í∏∞Ï°¥ Î†åÎçîÎßÅ Ï¥àÍ∏∞Ìôî
                storyList.forEach(story => renderStory(story));
            },
            error: function () {
                alert('Error loading stories.');
            }
        });
    };

    // ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú Í∏∞Ï°¥ Ïä§ÌÜ†Î¶¨ Î∂àÎü¨Ïò§Í∏∞
    loadStories();
});

   
    </script>
</body>
</html>
