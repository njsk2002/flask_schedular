
{% extends 'e_base.html' %}

{% block content %}

    <div class="container py-5">
        <h1 class="text-center">ğŸ“š Admin Image List</h1>
        <div class="d-flex justify-content-end mt-3">
            <select id="selecttype" class="form-select me-2" style="width: auto;">
                <option value="ì•„ì´ìœ " selected>ì•„ì´ìœ </option>
                <option value="ì„ì˜ì›…">ì„ì˜ì›…</option>
                <option value="ì¹´ë¦¬ë‚˜">ì¹´ë¦¬ë‚˜</option>
                <option value="ê³ ìœ¤ì •">ê³ ìœ¤ì •</option>
                <option value="ì¥ì›ì˜">ì¥ì›ì˜</option>
                <option value="ì§€ë“œë˜ê³¤">ì§€ë“œë˜ê³¤</option>
            </select>

            <select id="selectimage" class="form-select me-2" style="width: auto;">
                <option value="image" selected>Image</option>
                <option value="news">News</option>
                <option value="blog">Blog</option>
                <option value="youtube">UTUBE</option>
            </select>

            <button id="generateBtn" class="btn btn-primary">IMAGE ìƒì„±</button>
        </div>

       
       
  
        <!-- ë©”ì‹œì§€ ì¶œë ¥ -->
        {% if message %}
            <div class="alert alert-info mt-4 text-center">
                {{ message }}
            </div>
        {% endif %}
    
        <!-- ì´ë¯¸ì§€ ë¦¬ìŠ¤íŠ¸ ì¶œë ¥ -->
        <div id="imageContainer" class="mt-4">
            <div id="imagetype" class="card mb-4" style="width: 100%; text-align: center;">           
                <!-- ì„œë²„ì— ë“±ë¡ëœ ì´ë¯¸ì§€(key_word) í‘œì‹œ -->
            </div>
            
            {% if data %}
            {% for image in data %}
            <div class="card mb-4">
                <div class="card-body">
                    <!-- ê³ ì •ëœ ì´ë¯¸ì§€ ì»¨í…Œì´ë„ˆ: ë†’ì´ 250pxë¡œ ê³ ì • -->
                    <div class="image-container" style="width: 100%; height: 250px; overflow: hidden; text-align: center;">
                        <img id="image-{{ loop.index }}" src="{{ image.url }}" alt="{{ image.title_image }}" 
                             style="max-width: 100%; max-height: 100%; object-fit: contain;" />
                    </div>
                    <!-- ë²„íŠ¼ë“¤ì„ ì´ë¯¸ì§€ ì•„ë˜ìª½ì— ìœ„ì¹˜ -->
                    <div class="mt-3 text-center">
                        <button id="link-{{ loop.index }}" class="btn btn-outline-primary btn-sm me-2" onclick="openFullscreen('{{ image.url }}')">
                            <i class="fas fa-search-plus"></i> í¬ê²Œ ë³´ê¸°
                        </button>
                        <button class="btn btn-outline-success btn-sm toggle-format me-2" data-index="{{ loop.index }}" data-state="jpg" 
                                data-jpg="{{ image.url }}" data-bmp="/naverapi/get_bmp?key_word={{ image.key_word }}&bmp_file={{ image.bmp_42_mono }}">
                            <i class="fas fa-sync-alt"></i> 4.2 MONO
                        </button>
                        <button class="btn btn-outline-success btn-sm toggle-format me-2" data-index="{{ loop.index }}" data-state="jpg" 
                                data-jpg="{{ image.url }}" data-bmp="/naverapi/get_bmp?key_word={{ image.key_word }}&bmp_file={{ image.bmp_42_3color }}">
                            <i class="fas fa-sync-alt"></i> 4.2 COLOR
                        </button>
                        <button class="btn btn-outline-success btn-sm toggle-format me-2" data-index="{{ loop.index }}" data-state="jpg" 
                                data-jpg="{{ image.url }}" data-bmp="/naverapi/get_bmp?key_word={{ image.key_word }}&bmp_file={{ image.bmp_37_4color }}">
                            <i class="fas fa-sync-alt"></i> 3.7 COLOR
                        </button>
                        <button class="btn btn-outline-success btn-sm toggle-format" data-index="{{ loop.index }}" data-state="jpg" 
                                data-jpg="{{ image.url }}" data-bmp="/naverapi/get_bmp?key_word={{ image.key_word }}&bmp_file={{ image.bmp_29_4color }}">
                            <i class="fas fa-sync-alt"></i> 2.9 COLOR
                        </button>
                    </div>
                </div>
            </div>
            
            {% endfor %}
               
            {% else %}
                <p class="text-center">í‘œì‹œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
            {% endif %}
        </div>
        <button id="loadMoreBtn" class="btn btn-primary">ë” ë³´ê¸° </button>

        <!-- ì „ì²´ í™”ë©´ íŒì—… -->
        <div id="fullscreenModal" class="fullscreen-modal" onclick="closeFullscreen()">
            <span id="closeButton" class="close-button" onclick="closeFullscreen()">&#x2715;</span>
            <img id="fullscreenImage" src="" alt="Fullscreen Image" />
        </div>
        <!-- <div id="fullscreenModal" class="fullscreen-modal">
            <span id="closeButton" class="close-button">&#x2715;</span>
            <img id="fullscreenImage" src="" alt="Fullscreen Image" />
        </div>
         -->
        
    </div>
    

    <!-- Loading Modal -->
    <div class="modal fade" id="loadingModal" tabindex="-1" aria-labelledby="loadingModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-body text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-3">ìë£Œ ë³€í™˜ì¤‘...</p>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block script %}
    
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>


   <script>
       $(document).ready(function () {
           let currentPage = 1;  // í˜„ì¬ í˜ì´ì§€
           const perPage = 10;   // í˜ì´ì§€ë‹¹ í•­ëª© ìˆ˜

           $('#generateBtn').on('click', function () {
               $('#loadingModal').modal('show');

               // ì„ íƒëœ ê°’ ê°€ì ¸ì˜¤ê¸°
               const selectedType = $('#selecttype').val();
               const selectedImage = $('#selectimage').val();

               // POST ìš”ì²­
               $.ajax({
                   url: '/naverapi/generate_image',
                   method: 'POST',
                   contentType: 'application/json',
                   data: JSON.stringify({
                       key_word: selectedType,
                       request_type: selectedImage
                   }),
                   success: function (response) {
                       // ì„œë²„ì—ì„œ ë°ì´í„°ê°€ ë¹ˆ ê²½ìš° ì²˜ë¦¬
                       if (response.length === 0) {
                           $('#imageContainer').html('<p class="text-center">í‘œì‹œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>');
                       } else {
                           renderImages(response);
                       }
                   },
                   error: function () {
                       alert('Error generating images.');
                   },
                   complete: function () {
                       $('#loadingModal').modal('hide');
                   }
               });
           });


           const renderImages = (images) => {
                const imageContainer = $('#imageContainer');

                images.forEach(image => {
                    const imageHtml = `
                        <div class="card mb-4">
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-4 text-center">
                                        <img src="${image.url}" alt="${image.title_image}" style="width: 100%; height: auto;" />
                                    </div>
                                    <div class="col-md-8">
                                        <h5>${image.title_image}</h5>
                                        <p><strong>Update Date:</strong> ${image.update_date}</p>
                                        <p><strong>Thumbnail:</strong> ${image.thumbnail}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    imageContainer.append(imageHtml);
                });
            };

            const loadImages = () => {
                $.ajax({
                    url: '/naverapi/admin_image',
                    method: 'GET',
                    data: { 
                        page: currentPage, 
                        per_page: perPage 
                    },
                    success: function (response) {
                        console.log("ì „ì²´ ì‘ë‹µ ë°ì´í„°:", response);

                        if (response.unique_key && response.unique_key.length > 0) {
                            let uniqueHtml = `
                                <div class="unique-slider-container" style="position: relative; display: flex; align-items: center;">
                                    <!-- ì¢Œì¸¡ í™”ì‚´í‘œ ë²„íŠ¼ (íˆ¬ëª…ë„ 70%, ë¼ìš´ë“œ ë„¤ëª¨) -->
                                    <button class="slider-arrow left-arrow" style="border: none; background: rgba(0, 0, 0, 0.7); cursor: pointer; font-size: 24px; border-radius: 8px; padding: 8px; position: absolute; left: 0; z-index: 10;">
                                        <i class="fas fa-chevron-left" style="color: #fff;"></i>
                                    </button>
                                    <!-- ìŠ¬ë¼ì´ë” ì˜ì—­ -->
                                    <div class="unique-slider" style="overflow: hidden; flex-grow: 1; margin: 0 50px;">
                                        <div class="unique-slider-inner" style="display: flex; justify-content: center; align-items: center;">
                            `;
                            response.unique_key.forEach(item => {
                                uniqueHtml += `
                                    <div class="unique-key-item" 
                                        style="position: relative; width: 100px; height: 100px; margin: 0 10px; text-align: center; cursor: pointer;"
                                        onclick="location.href='/naverapi/admin_image?key_word=${encodeURIComponent(item.key_word)}'">
                                        <img src="${item.url}" alt="${item.key_word}" 
                                            style="width: 100px; height: 100px; object-fit: cover; display: block;">
                                        <div style="position: absolute; bottom: 0; left: 0; width: 100%; background: rgba(0, 0, 0, 0.5); color: #fff; font-size: 14px; padding: 2px;">
                                            ${item.key_word}
                                        </div>
                                    </div>
                                `;
                            });
                            uniqueHtml += `
                                        </div>
                                    </div>
                                    <!-- ìš°ì¸¡ í™”ì‚´í‘œ ë²„íŠ¼ (íˆ¬ëª…ë„ 70%, ë¼ìš´ë“œ ë„¤ëª¨) -->
                                    <button class="slider-arrow right-arrow" style="border: none; background: rgba(0, 0, 0, 0.7); cursor: pointer; font-size: 24px; border-radius: 8px; padding: 8px; position: absolute; right: 0; z-index: 10;">
                                        <i class="fas fa-chevron-right" style="color: #fff;"></i>
                                    </button>
                                </div>
                            `;
                            $("#imagetype").html(uniqueHtml);

                            // ì¢Œì¸¡, ìš°ì¸¡ í™”ì‚´í‘œ í´ë¦­ ì‹œ ìŠ¬ë¼ì´ë” ì´ë™ ì²˜ë¦¬
                            $(".left-arrow").on("click", function() {
                                $(".unique-slider").animate({ scrollLeft: "-=100" }, 300);
                            });
                            $(".right-arrow").on("click", function() {
                                $(".unique-slider").animate({ scrollLeft: "+=100" }, 300);
                            });
                        } else {
                            console.log("ë“±ë¡ëœ ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.!!");
                        }



                        if (response.data && response.data.length > 0) {
                            // unique_key ë°ì´í„°ë¥¼ #imagetype ì˜ì—­ì— í‘œì‹œ
                           // ì´ë¯¸ì§€ ì¹´ë“œ ìƒì„±
                            let currentIndex = currentPage * 10; // í˜„ì¬ í˜ì´ì§€ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ê³ ìœ  ì¸ë±ìŠ¤ ìƒì„±
                            response.data.forEach((image, index) => {
                                const uniqueIndex = currentIndex + index + 1;
                                const imageHtml = `
                                    <div class="card mb-4">
                                        <div class="card-body">
                                            <!-- ê³ ì •ëœ ì´ë¯¸ì§€ ì»¨í…Œì´ë„ˆ -->
                                            <div class="image-container" style="width: 100%; height: 250px; overflow: hidden; text-align: center;">
                                                <img id="image-${uniqueIndex}" src="${image.url}" alt="${image.title_image}" 
                                                    style="max-width: 100%; max-height: 100%; object-fit: contain;" />
                                            </div>
                                            <!-- ë²„íŠ¼ë“¤ì„ ì´ë¯¸ì§€ ì•„ë˜ìª½ì— ë°°ì¹˜ -->
                                            <div class="mt-3 text-center">
                                                <button class="btn btn-outline-primary btn-sm me-2" onclick="openFullscreen('${image.url}')">
                                                    <i class="fas fa-search-plus"></i> í¬ê²Œ ë³´ê¸°
                                                </button>
                                                <button class="btn btn-outline-success btn-sm toggle-format me-2" data-index="${uniqueIndex}" data-state="jpg" data-jpg="${image.url}" data-bmp="/naverapi/get_bmp?key_word=${image.key_word}&bmp_file=${image.bmp_42_mono}">
                                                    <i class="fas fa-sync-alt"></i> 4.2 MONO
                                                </button>
                                                <button class="btn btn-outline-success btn-sm toggle-format me-2" data-index="${uniqueIndex}" data-state="jpg" data-jpg="${image.url}" data-bmp="/naverapi/get_bmp?key_word=${image.key_word}&bmp_file=${image.bmp_42_3color}">
                                                    <i class="fas fa-sync-alt"></i> 4.2 COLOR
                                                </button>
                                                <button class="btn btn-outline-success btn-sm toggle-format me-2" data-index="${uniqueIndex}" data-state="jpg" data-jpg="${image.url}" data-bmp="/naverapi/get_bmp?key_word=${image.key_word}&bmp_file=${image.bmp_37_4color}">
                                                    <i class="fas fa-sync-alt"></i> 3.7 COLOR
                                                </button>
                                                <button class="btn btn-outline-success btn-sm toggle-format" data-index="${uniqueIndex}" data-state="jpg" data-jpg="${image.url}" data-bmp="/naverapi/get_bmp?key_word=${image.key_word}&bmp_file=${image.bmp_29_4color}">
                                                    <i class="fas fa-sync-alt"></i> 2.9 COLOR
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                `;
                                $('#imageContainer').append(imageHtml);

                            });
                                                
                            // ë‹¤ìŒ í˜ì´ì§€ë¥¼ ìœ„í•´ currentPage ì¦ê°€
                            currentPage += 1;
                        } else {
                            alert("ë” ì´ìƒ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
                            $('#loadMoreBtn').hide();
                        }
                    },
                    error: function () {
                        alert("ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                    }
                });
            };

            // ì´ˆê¸° ë°ì´í„° ë¡œë“œ
            loadImages();



           
           // BMPì™€ JPG ì „í™˜ ë²„íŠ¼ ì²˜ë¦¬
        $(document).on("click", ".toggle-format", function () {
            const $btn = $(this);
            const index = $btn.data("index");
            const imgElement = $(`#image-${index}`);
            const currentState = $btn.data("state");  // í˜„ì¬ ìƒíƒœ: 'jpg' ë˜ëŠ” 'bmp'
            const jpgSrc = $btn.data("jpg");
            const bmpSrc = $btn.data("bmp");

            // ìµœì´ˆ í´ë¦­ ì‹œ ì›ë˜ ë²„íŠ¼ í…ìŠ¤íŠ¸(ì•„ì´ì½˜ ì œì™¸)ë¥¼ ì €ì¥
            if (!$btn.data("original-text")) {
                // ì•„ì´ì½˜ì„ ì œì™¸í•œ í…ìŠ¤íŠ¸ë§Œ ì €ì¥í•˜ê±°ë‚˜, ì „ì²´ HTMLì„ ì €ì¥í•  ìˆ˜ë„ ìˆìŒ
                $btn.data("original-text", $btn.text().trim());
            }
            const originalLabel = $btn.data("original-text");

            console.log("Index:", index);
            console.log("Current state:", currentState);
            console.log("JPG Src:", jpgSrc);
            console.log("BMP Src:", bmpSrc);

            if (currentState === "jpg") {
                // BMP ë³´ê¸°: ìºì‹± ë°©ì§€ ì¿¼ë¦¬ ìŠ¤íŠ¸ë§ ì¶”ê°€
                const uniqueBmpSrc = `${bmpSrc}?t=${new Date().getTime()}`;
                imgElement.attr("src", uniqueBmpSrc);
                $btn.data("state", "bmp");
                // BMPë¡œ ì „í™˜ í›„, ë²„íŠ¼ í…ìŠ¤íŠ¸ë¥¼ "JPG ë³´ê¸°"ë¡œ ë³€ê²½
                $btn.html('<i class="fas fa-sync-alt"></i> JPG ë³´ê¸°');
                console.log("Switched to BMP");
            } else {
                // JPG ë³´ê¸°
                imgElement.attr("src", jpgSrc);
                $btn.data("state", "jpg");
                // ì›ë˜ ì €ì¥í•´ë‘” í…ìŠ¤íŠ¸(ì˜ˆ: "2.9 COLOR", "3.7 COLOR")ë¡œ ë³µì›
                $btn.html(`<i class="fas fa-sync-alt"></i> ${originalLabel}`);
                console.log("Switched to JPG");
            }
        });



           // "ë”ë³´ê¸°" ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
           $('#loadMoreBtn').on('click', function () {
               console.log("ë”ë³´ê¸° ë²„íŠ¼ í´ë¦­");
               if (currentPage == 1){
                 currentPage = 2;
                 loadImages();
               }
               loadImages();
           });


            // ì „ì²´ í™”ë©´ ì—´ê¸°
            $(document).on('click', '.btn-outline-primary', function () {
                const imageUrl = $(this).attr('onclick').match(/'(.*?)'/)[1]; // ì´ë¯¸ì§€ URL ì¶”ì¶œ
                const modal = $('#fullscreenModal');
                const fullscreenImage = $('#fullscreenImage');

                fullscreenImage.attr('src', imageUrl);
                modal.css('display', 'flex'); // ëª¨ë‹¬ ë³´ì´ê¸°
            });

            // ì „ì²´ í™”ë©´ ë‹«ê¸°
            $(document).on('click', '#fullscreenModal, #closeButton', function () {
                const modal = $('#fullscreenModal');
                modal.css('display', 'none'); // ëª¨ë‹¬ ìˆ¨ê¸°ê¸°
            });

       });
</script>
{% endblock %}
