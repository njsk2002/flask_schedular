{% extends 'e_base.html' %}

{% block content %}
<div class="container-fluid py-3">

  <div class="d-flex align-items-center justify-content-between mb-3">
    <h3 class="mb-0">E-Ink ì „ì†¡ ëŒ€ì‹œë³´ë“œ (3Ã—2)</h3>
    <div>
      <button id="btn-send-all" class="btn btn-primary">ì „ì²´ ì „ì†¡</button>
    </div>
  </div>

  <!-- ìƒíƒœ ì•Œë¦¼ -->
  <div id="toast-area" class="position-fixed top-0 end-0 p-3" style="z-index:1080;"></div>

  <!-- NEW: í”„ë¦¬ë·°/ë²„íŠ¼ í¬ê¸° ì¡°ì ˆìš© ê²½ëŸ‰ CSS -->
  <style>
    .btn-nav-sm { padding: .15rem .35rem; font-size: .75rem; line-height: 1; }

    .preview-surface {
      height: clamp(300px, 40vh, 520px);
      width: auto;
      max-width: 100%;
      margin-inline: auto;
      background: #f8f9fa;
      overflow: hidden;
      border-radius: .375rem;
    }
    .preview-img { width: 100%; height: 100%; object-fit: contain; }
  </style>

  <!-- 3Ã—2 ê·¸ë¦¬ë“œ -->
  <div id="tiles" class="row row-cols-1 row-cols-md-3 g-3">
    {% for i in range(1,7) %}
    {% set num = "%02d" % i %}
    <div class="col">
      <div class="card shadow-sm h-100" data-device-no="{{ num }}" data-device-id="E{{ num }}">
        <div class="card-header d-flex justify-content-between align-items-center">
          <strong>E-INK/{{ num }}</strong>
          <span class="badge text-bg-secondary">E{{ num }}</span>
        </div>

        <div class="card-body d-flex flex-column gap-2">
          <!-- 1ROW -->
          <div class="d-flex flex-column gap-2">
            <div class="d-flex align-items-center gap-2">
              <div class="flex-grow-1 text-truncate">
                <span class="fw-semibold">íŒŒì¼ëª…:</span>
                <span class="file-name" title="íŒŒì¼ëª…">-</span>
              </div>
              <input type="file" class="d-none file-input"
                     accept=".pdf,.png,.jpg,.jpeg,.bmp,.ppt,.pptx,.doc,.docx,.xls,.xlsx,.csv,.txt"/>
              <button class="btn btn-sm btn-outline-primary btn-choose">ì„ íƒ</button>
            </div>
            <input type="text" class="form-control form-control-sm memo-input" placeholder="ë©”ëª¨ ì…ë ¥(ì˜µì…˜)">
          </div>

          <!-- 2ROW -->
          <div class="row g-2">
            <div class="col-4">
              <label class="form-label mb-1 small">í•´ìƒë„</label>
              <select class="form-select form-select-sm select-resolution">
                <option value="480x800" selected>480Ã—800</option>
                <option value="1200x1600">1200Ã—1600</option>
              </select>
            </div>
            <div class="col-4">
              <label class="form-label mb-1 small">í™”ë©´ì„ íƒ</label>
              <select class="form-select form-select-sm select-scale">
                <option value="fit" selected>FIT</option>
                <option value="fill">FILL</option>
                <option value="percent">PERCENT</option>
              </select>
            </div>
            <div class="col-4">
              <label class="form-label mb-1 small">ì»¬ëŸ¬</label>
              <select class="form-select form-select-sm select-mode">
                <option value="BWRYBG" selected>COLOR6 (BWRYBG)</option>
                <option value="BW">MONO (BW)</option>
                <option value="BWRY">COLOR (BWRY)</option>
              </select>
            </div>
            <div class="col-12 percent-row d-none">
              <label class="form-label mb-1 small">ë°°ìœ¨(%)</label>
              <input type="range" class="form-range percent-input" min="50" max="200" step="1" value="100">
            </div>
          </div>

          <!-- 3ROW: í”„ë¦¬ë·° ì˜ì—­ -->
          <div class="preview-wrap flex-grow-1 d-flex align-items-center justify-content-center">
            <div class="preview-surface border" style="aspect-ratio: 3 / 5;">
              <img class="preview-img" src="" alt="ë¯¸ë¦¬ë³´ê¸°">
            </div>
          </div>

          <!-- 4ROW: ì´ì „/ì´í›„/íšŒì „/ì›ë³¸/ì „ì†¡ -->
          <div class="d-flex align-items-center justify-content-between">
            <div class="btn-group" role="group">
              <button class="btn btn-outline-secondary btn-nav-sm btn-prev" type="button">ì´ì „</button>
              <span class="px-2 small page-indicator">- / -</span>
              <button class="btn btn-outline-secondary btn-nav-sm btn-next" type="button">ì´í›„</button>
            </div>

            <div class="d-flex gap-2 align-items-center">
              <div class="d-flex align-items-center gap-1">
                <label class="form-label mb-0 small">íšŒì „</label>
                <select class="form-select form-select-sm select-rotate" style="width:auto;">
                  <option value="0" selected>0Â°</option>
                  <option value="90">90Â°</option>
                  <option value="180">180Â°</option>
                  <option value="270">270Â°</option>
                </select>
              </div>

              <button class="btn btn-outline-dark btn-original" type="button" title="ì›ë³¸ ë³´ê¸° í† ê¸€">ì›ë³¸</button>
              <button class="btn btn-success btn-send" type="button">ì „ì†¡</button>
            </div>
          </div>
        </div> <!-- /card-body -->

      </div> <!-- /card -->
    </div>   <!-- /col -->
    {% endfor %}
  </div> <!-- /#tiles -->

</div> <!-- /.container-fluid -->
{% endblock %}


{% block script %}
<script type="application/json" id="devices-json">
  {{ devices|default([], true)|tojson }}
</script>

<script>
(() => {
  // ì•ˆì „í•œ JSON ì£¼ì…
  let injected = [];
  try {
    const tag = document.getElementById('devices-json');
    if (tag && tag.textContent.trim()) injected = JSON.parse(tag.textContent);
  } catch(e){}

  // ê¸°ë³¸ ë””ë°”ì´ìŠ¤
  const fallback = [
    {device_no:'01', device_id:'E01', name:'E-INK/01', supports:['BW','BWRY','BWRYBG'], default_width:480,  default_height:800},
    {device_no:'02', device_id:'E02', name:'E-INK/02', supports:['BW','BWRY','BWRYBG'], default_width:480,  default_height:800},
    {device_no:'03', device_id:'E03', name:'E-INK/03', supports:['BW','BWRY','BWRYBG'], default_width:480,  default_height:800},
    {device_no:'04', device_id:'E04', name:'E-INK/04', supports:['BW','BWRY','BWRYBG'], default_width:480,  default_height:800},
    {device_no:'05', device_id:'E05', name:'E-INK/05', supports:['BW','BWRY','BWRYBG'], default_width:480,  default_height:800},
    {device_no:'06', device_id:'E06', name:'E-INK/06', supports:['BW','BWRY','BWRYBG'], default_width:480,  default_height:800},
  ];
  const devices = (Array.isArray(injected) && injected.length) ? injected : fallback;

  function toast(msg, type='info') {
    const id = 't'+Date.now()+Math.random().toString(16).slice(2);
    const el = document.createElement('div');
    el.id = id;
    el.className = `toast align-items-center text-bg-${type} border-0 show`;
    el.innerHTML = `<div class="d-flex"><div class="toast-body">${msg}</div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" onclick="this.closest('.toast').remove()"></button></div>`;
    (document.querySelector('#toast-area') || document.body).appendChild(el);
    setTimeout(()=>el.remove(), 4000);
  }

  /** "800x480" â†’ {width:800, height:480} */
  function parseResolution(v){
    const [w,h]=v.split('x').map(Number);
    return {width:w, height:h};
  }

  /** í”„ë¦¬ë·° ë°•ìŠ¤ ë¹„ìœ¨ ê³„ì‚°(íšŒì „ ë¬´ì‹œ, 800Ã—480ë§Œ ì„¸ë¡œ 480:800ë¡œ ê³ ì •) */
  function getPreviewBoxDims(selW, selH){
    // if (selW === 800 && selH === 480) return {pw:480, ph:800};
    // return {pw:selW, ph:selH}; // 1200Ã—1600 ë“±ì€ ê·¸ëŒ€ë¡œ

        // 800Ã—480ì€ ì„¸ë¡œ(480:800)ë¡œ ê³ ì •, 1200Ã—1600ì€ 3:4ë¡œ ê¹”ë”íˆ
      if (selW === 800 && selH === 480)   return {pw:3, ph:5}; // 480:800
      if (selW === 1200 && selH === 1600) return {pw:3, ph:4}; // 1200:1600
      return {pw:selW, ph:selH};
      }

  /** í”„ë¦¬ë·° ìº”ë²„ìŠ¤ì˜ aspect-ratioë¥¼ 'ê³ ì •' ê°±ì‹  */
  function applyPreviewAspect(card, s){
    const surface = card.querySelector('.preview-surface');
    if (!surface) return;
    const {pw, ph} = getPreviewBoxDims(s.uiWidth, s.uiHeight);
    surface.style.aspectRatio = `${pw} / ${ph}`;
  }

  // ---- ë¯¸ë¦¬ë³´ê¸° (JSON) : UI í•´ìƒë„ + íšŒì „ ì „ë‹¬ (ì„œë²„ëŠ” ê·¸ëŒ€ë¡œ PNG ìƒì„±) ----
  async function updatePreviewFromJson(s, imgEl, raw=0){
    if (!s.upload_id) return;
    const body = {
      upload_id: s.upload_id,
      width:  s.uiWidth,
      height: s.uiHeight,
      mode: s.mode,            // â† ì„ íƒê°’ ê·¸ëŒ€ë¡œ ì „ë‹¬ (BWRYBG|BW|BWRY)
      scale: s.scale,
      percent: s.percent,
      rotate: s.rotate,
      raw
    };
    const r = await fetch('/bulletin/preview_blob', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify(body)
    });
    if (!r.ok) throw new Error('preview_blob json failed');
    const blob = await r.blob();
    const url = URL.createObjectURL(blob);
    imgEl.src = url + '#t=' + Date.now();
    if (s._prevUrl) URL.revokeObjectURL(s._prevUrl);
    s._prevUrl = url;
  }

  // ---- ë¯¸ë¦¬ë³´ê¸° (íŒŒì¼ ì—…ë¡œë“œ) : UI í•´ìƒë„ + íšŒì „ ì „ë‹¬ ----
  async function updatePreviewFromFile(file, s, imgEl){
    const fd = new FormData();
    fd.append('file', file);
    fd.append('width',  s.uiWidth);
    fd.append('height', s.uiHeight);
    fd.append('mode',   s.mode);      // â† ì„ íƒê°’ ê·¸ëŒ€ë¡œ ì „ë‹¬
    fd.append('scale',  s.scale);
    fd.append('percent', s.percent);
    fd.append('rotate', s.rotate);
    fd.append('raw', 0);

    const r = await fetch('/bulletin/preview_blob', {method:'POST', body: fd});
    if (!r.ok) throw new Error('preview_blob multipart failed');

    const upid = r.headers.get('X-Upload-Id');
    if (upid) s.upload_id = parseInt(upid, 10);

    const blob = await r.blob();
    const url = URL.createObjectURL(blob);
    if (s._prevUrl) URL.revokeObjectURL(s._prevUrl);
    s._prevUrl = url;
    imgEl.src  = url + '#t=' + Date.now();
  }

  function bindTile(card){
    const deviceNo = card.dataset.deviceNo;
    const deviceId = card.dataset.deviceId;
    const spec = devices.find(d=>d.device_no===deviceNo) || {};
    const s = {
      device_no: deviceNo,
      device_id: deviceId,
      upload_id: null,
      file_name: '-',
      pages: 1, page: 1,

      // UI í”„ë¦¬ë·° ê¸°ì¤€ í•´ìƒë„
      uiWidth:  spec.default_width  || 480,
      uiHeight: spec.default_height || 800,

      mode: 'BWRYBG',   // â† ê¸°ë³¸ê°’ì„ HTML ê¸°ë³¸ ì„ íƒ(BWRYBG)ê³¼ ì¼ì¹˜ì‹œí‚´
      scale: 'fit',
      percent: 100,
      rotate: 0,
      view: 'processed',
      _prevUrl: null
    };

    const $fileName   = card.querySelector('.file-name');
    const $fileInput  = card.querySelector('.file-input');
    const $btnChoose  = card.querySelector('.btn-choose');
    const $selRes     = card.querySelector('.select-resolution');
    const $selScale   = card.querySelector('.select-scale');
    const $selMode    = card.querySelector('.select-mode');
    const $percentRow = card.querySelector('.percent-row');
    const $percent    = card.querySelector('.percent-input');
    const $preview    = card.querySelector('.preview-img');
    const $pageInd    = card.querySelector('.page-indicator');
    const $btnSend    = card.querySelector('.btn-send');
    const $btnOriginal= card.querySelector('.btn-original');
    const $selRotate  = card.querySelector('.select-rotate');

    // ğŸ”‘ selectì˜ í˜„ì¬ê°’ì„ ìƒíƒœì— ì¦‰ì‹œ ë°˜ì˜ (ì´ˆê¸° ë¡œë“œ ì‹œ ë¶ˆì¼ì¹˜ ë°©ì§€)
    s.mode = $selMode.value;

    function refreshPercentRow(){ $percentRow.classList.toggle('d-none', s.scale!=='percent'); }
    function redrawIndicators(){
      $pageInd.textContent = `${s.page} / ${s.pages}`;
      $fileName.textContent = s.file_name || '-';
    }

    // íŒŒì¼ ì„ íƒ â†’ multipartë¡œ ë¯¸ë¦¬ë³´ê¸°(ì²˜ë¦¬ë³¸) ìƒì„±
    $btnChoose.addEventListener('click', ()=> $fileInput.click());
    $fileInput.addEventListener('change', async (ev)=>{
      const f = ev.target.files[0]; if(!f) return;
      s.file_name = f.name; s.pages = 1; s.page = 1; s.view = 'processed';
      try {
        applyPreviewAspect(card, s);
        await updatePreviewFromFile(f, s, $preview);  // modeëŠ” s.mode(BWRYBG|BW|BWRY)
        redrawIndicators();
        toast(`[${deviceNo}] ë¯¸ë¦¬ë³´ê¸° ì¤€ë¹„`, 'success');
      } catch (e) {
        toast(`[${deviceNo}] ë¯¸ë¦¬ë³´ê¸° ì‹¤íŒ¨`, 'danger');
      } finally {
        $fileInput.value = '';
      }
    });

    // ì˜µì…˜ ë³€ê²½ ì‹œ: í˜„ì¬ ë·°(view)ì— ë§ì¶° ì„œë²„ë¡œ ì¬ëœë” ìš”ì²­
    async function refreshPreviewByState(){
      if (!s.upload_id) return;
      try {
        applyPreviewAspect(card, s);
        await updatePreviewFromJson(s, $preview, s.view === 'original' ? 1 : 0); // mode ì „ë‹¬ í¬í•¨
        redrawIndicators();
      } catch(e) {
        toast(`[${deviceNo}] ë¯¸ë¦¬ë³´ê¸° ì‹¤íŒ¨`, 'danger');
      }
    }

    // í•´ìƒë„ ë³€ê²½
    $selRes.addEventListener('change', ()=>{
      const {width,height}=parseResolution($selRes.value);
      s.uiWidth  = width;
      s.uiHeight = height;
      applyPreviewAspect(card, s);   // â† ì—…ë¡œë“œ ì—¬ë¶€ì™€ ê´€ê³„ì—†ì´ í”„ë¦¬ë·° ë°•ìŠ¤ ë¹„ìœ¨ ë°”ë¡œ ê°±ì‹ 
      refreshPercentRow();
      refreshPreviewByState();
    });

    $selScale.addEventListener('change', ()=>{
      s.scale=$selScale.value;
      refreshPercentRow();
      refreshPreviewByState();
    });

    $percent.addEventListener('input', ()=>{
      s.percent=parseInt($percent.value,10)||100;
      if (s.scale==='percent') refreshPreviewByState();
    });

    // ğŸ”‘ ì»¬ëŸ¬ ëª¨ë“œ ë³€ê²½: s.mode â† select ê°’ ê·¸ëŒ€ë¡œ
    $selMode.addEventListener('change', ()=>{
      s.mode=$selMode.value;         // "BWRYBG" | "BW" | "BWRY"
      refreshPreviewByState();
    });

    // íšŒì „
    $selRotate.addEventListener('change', ()=>{
      s.rotate = parseInt($selRotate.value, 10) || 0;
      applyPreviewAspect(card, s);   // ì»¨í…Œì´ë„ˆëŠ” í•­ìƒ í˜„ì¬ í•´ìƒë„ ê¸°ì¤€ ë¹„ìœ¨ ìœ ì§€
      refreshPreviewByState();
    });

    // í˜ì´ì§€ ì´ë™
    card.querySelector('.btn-prev').addEventListener('click', ()=>{
      if(!s.upload_id) return; s.view='processed';
      s.page=Math.max(1,(s.page||1)-1); refreshPreviewByState();
    });
    card.querySelector('.btn-next').addEventListener('click', ()=>{
      if(!s.upload_id) return; s.view='processed';
      s.page=Math.min(s.pages||1,(s.page||1)+1); refreshPreviewByState();
    });

    // ì›ë³¸ í† ê¸€
    $btnOriginal.addEventListener('click', ()=>{
      if (!s.upload_id) { toast(`[${deviceNo}] íŒŒì¼ì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”.`, 'warning'); return; }
      s.view = (s.view === 'processed') ? 'original' : 'processed';
      $btnOriginal.classList.toggle('active', s.view === 'original');
      refreshPreviewByState();
    });

    // í•´ìƒë„ë³„ íšŒì „ ë§¤í•‘ (ì´ì „ê³¼ ë™ì¼)
    function mapRotateForWire(uiRotate){
      const norm = ((uiRotate % 360) + 360) % 360;
      const is1200x1600 = (s.uiWidth === 1200 && s.uiHeight === 1600);
      const table = is1200x1600
        ? { 0:0, 90:90, 180:180, 270:270 }
        : { 0:270, 90:0, 180:90, 270:180 };
      return table[norm] ?? 0;
    }

    $btnSend.addEventListener('click', async ()=>{
      if (!s.upload_id) { toast(`[${deviceNo}] ì „ì†¡í•  íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.`, 'warning'); return; }
      const body = {
        upload_id: s.upload_id,
        page: s.page || 1,
        device_id: s.device_id,
        mode: s.mode,             // â† ì„ íƒê°’ ê·¸ëŒ€ë¡œ ì „ë‹¬
        scale: s.scale,
        percent: s.percent,
        rotate: mapRotateForWire(s.rotate),
        width:  s.uiWidth,
        height: s.uiHeight
      };
      try{
        const r = await fetch('/bulletin/sendfile', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify(body)
        });
        const js = await r.json();
        toast(`[${deviceNo}] ì „ì†¡ ì¤€ë¹„ ì™„ë£Œ (job #${js.job_id})`, 'info');
      }catch(e){ toast(`[${deviceNo}] ì „ì†¡ ì‹¤íŒ¨`, 'danger'); }
    });

    // ì´ˆê¸° UI ìƒíƒœ
    refreshPercentRow();
    applyPreviewAspect(card, s);
  }

  // ëª¨ë“  ì¹´ë“œ ë°”ì¸ë”©
  document.querySelectorAll('#tiles .card').forEach(bindTile);
  document.getElementById('btn-send-all').addEventListener('click', ()=>{
    document.querySelectorAll('#tiles .card .btn-send').forEach(btn=>btn.click());
  });
})();
</script>
{% endblock %}
