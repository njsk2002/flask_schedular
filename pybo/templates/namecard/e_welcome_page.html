{% extends 'e_base.html' %}

{% block content %}
<div class="container mt-4">
    <h2 class="text-center mb-4">Welcome Page</h2>

    {% if error_message %}
        <div class="alert alert-danger" role="alert">
            {{ error_message }}
        </div>
    {% endif %}

    <!-- âœ… QR ì½”ë“œ -->
    <!-- <div class="text-center">
        <h4>ğŸ“Œ QR ì½”ë“œ</h4>
        <img src="{{ welcome_data.qr_code }}" class="qr-code-img" alt="QR Code">
    </div> -->

    <!-- âœ… ì¸ì‚¬ë§ -->
    <div class="title-box mt-4">
        <h4>ğŸ’¬ ì œëª©</h4>
        <h3>{{ share_card.title or 'ì—†ìŒ' }}</h3>
    </div>

    <!-- âœ… ì¸ì‚¬ë§ -->
    <div class="message-box mt-4">
        <h4>ğŸ’¬ ì¸ì‚¬ë§</h4>
        <p>{{ share_card.introduce or 'ì—†ìŒ' }}</p>
    </div>

    <!-- âœ… ë‚´ìš© -->
    <div class="content-box mt-3">
        <h4>ğŸ“„ ë‚´ìš©</h4>
        <p>{{ share_card.content }}</p>
    </div>

    <!-- âœ… ëª…í•¨ ì •ë³´ -->
    {% if namecard %}
    <div class="namecard-box mt-4 p-3 shadow-sm">
        <h4>ğŸ“Œ ëª…í•¨ ì •ë³´</h4>
        <div class="d-flex align-items-center">
            <!-- í”„ë¡œí•„ ì‚¬ì§„ -->
            <img src="{{ namecard.selected_photo or '/static/default_profile.jpg' }}" 
                 class="rounded-circle profile-img me-3">
            
            <div>
                <!-- ì´ë¦„ ë° ì§ê¸‰ -->
                <strong class="name-highlight">{{ namecard.username or 'ì´ë¦„ ì—†ìŒ' }}</strong> 
                ({{ namecard.position or 'ì§ê¸‰ ì—†ìŒ' }})<br>
                
                <!-- íšŒì‚¬ëª… -->
                ğŸ¢ {{ namecard.company or 'íšŒì‚¬ ì—†ìŒ' }}<br>
                
                <!-- ì´ë©”ì¼ -->
                ğŸ“§ <a href="mailto:{{ namecard.email }}" class="email-text">
                    {{ namecard.email or 'ì´ë©”ì¼ ì—†ìŒ' }}
                </a> <br>
                
                <!-- ìŠ¤ë§ˆíŠ¸í° ì „í™”ë²ˆí˜¸ -->
                ğŸ“± {{ namecard.phone or 'ì „í™” ì—†ìŒ' }} <br>
                
                <!-- ëŒ€í‘œ ì „í™” & ì§í†µ ì „í™” -->
                â˜ {{ namecard.tel_rep or 'ëŒ€í‘œë²ˆí˜¸ ì—†ìŒ' }} | ğŸ“ {{ namecard.tel_dir or 'ì§í†µë²ˆí˜¸ ì—†ìŒ' }} <br>

                <!-- íŒ©ìŠ¤ -->
                ğŸ“  {{ namecard.fax or 'íŒ©ìŠ¤ ì—†ìŒ' }}<br>

                <!-- ì£¼ì†Œ -->
                ğŸ“ {{ namecard.com_address or 'ì£¼ì†Œ ì—†ìŒ' }}<br>

                <!-- í™ˆí˜ì´ì§€ -->
                ğŸŒ <a href="http://{{ namecard.homepage }}" target="_blank">
                    {{ namecard.homepage or 'í™ˆí˜ì´ì§€ ì—†ìŒ' }}
                </a>
            </div>
        </div>
    </div>
   <!-- âœ… "ëª…í•¨ ë‚´ í°ì— ì €ì¥" ë²„íŠ¼ -->
   <div class="text-center mt-4">
        <button class="btn btn-success" onclick="saveToPhone('{{ namecard.id }}', '{{ welcome_data.unique_id }}', '{{ welcome_data.no }}')">
            ğŸ“¥ ëª…í•¨ ë‚´ í°ì— ì €ì¥
        </button>
    </div>
    {% else %}
        <p class="text-muted">ëª…í•¨ ì •ë³´ ì—†ìŒ</p>
    {% endif %}

    <!-- âœ… ê³µìœ ëœ íŒŒì¼ ë¦¬ìŠ¤íŠ¸ -->
    <div class="file-box mt-4 p-3 shadow-sm">
        <h4>ğŸ“‚ ê³µìœ í•  íŒŒì¼</h4>
        {% set valid_files = share_card.s_file1, share_card.s_file2, share_card.s_file3, 
                            share_card.s_file4, share_card.s_file5 %}
        {% set valid_files = valid_files | select('string') | reject('eq', '') | list %}

        {% if valid_files | length > 0 %}
            <ul class="file-list">
                {% for file in valid_files %}
                    <li>
                        <i class="bi bi-file-earmark-text"></i> {{ file }}
                    </li>
                {% endfor %}
            </ul>
        {% else %}
            <p class="text-muted">ê³µìœ ëœ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.</p>
        {% endif %}
    </div>

    <!-- âœ… ì‘ì„±ì¼ -->
    <p class="text-muted small">ğŸ“… ì‘ì„±ì¼: {{welcome_data.create_date or 'ë‚ ì§œ ì—†ìŒ' }}</p>
    


</div>
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="/static/e_css/e_sharecard.css">
{% endblock %}

{% block script %}
<script>
   function saveToPhone(namecardId, uniqueId, welcomeDataNo) {
    fetch('/enamecard/generate_vcard', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            namecard_id: namecardId,
            unique_id: uniqueId,
            welcome_data_no: welcomeDataNo
        })
    })
    .then(response => response.blob())
    .then(blob => {
        let url = window.URL.createObjectURL(blob);
        let a = document.createElement('a');
        a.href = url;

        let filename = `${namecardId}_contact.vcf`;
        a.download = filename;

        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);

        // âœ… URL í•´ì œ (ë©”ëª¨ë¦¬ ì •ë¦¬)
        setTimeout(() => {
            window.URL.revokeObjectURL(url);
        }, 1000);

        // âœ… ëª¨ë°”ì¼ í™˜ê²½ì—ì„œ ìë™ ì‹¤í–‰ ë°©ì§€ (ì¤‘ë³µ ë‹¤ìš´ë¡œë“œ ë°©ì§€)
        if (navigator.userAgent.match(/(iPhone|iPad|Android)/)) {
            setTimeout(() => {
                window.open(url, '_blank');
            }, 500);
        }
    })
    .catch(error => {
        console.error("Error:", error);
        alert("ëª…í•¨ ì €ì¥ ì¤‘ ì˜¤ë¥˜ ë°œìƒ");
    });
}

</script>
{% endblock %}
