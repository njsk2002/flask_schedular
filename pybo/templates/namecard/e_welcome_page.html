{% extends 'e_base.html' %}

{% block content %}
<div class="container mt-4">
    <h2 class="text-center mb-4">Welcome Page</h2>

    {% if error_message %}
        <div class="alert alert-danger" role="alert">
            {{ error_message }}
        </div>
    {% endif %}

    <!-- âœ… QR ì½”ë“œ -->
    <!-- <div class="text-center">
        <h4>ğŸ“Œ QR ì½”ë“œ</h4>
        <img src="{{ welcome_data.qr_code }}" class="qr-code-img" alt="QR Code">
    </div> -->

    <!-- âœ… ì¸ì‚¬ë§ -->
    <div class="title-box mt-4">
        <h4>ğŸ’¬ ì œëª©</h4>
        <h3>{{ share_card.title or 'ì—†ìŒ' }}</h3>
    </div>

    <!-- âœ… ì¸ì‚¬ë§ -->
    <div class="message-box mt-4">
        <h4>ğŸ’¬ ì¸ì‚¬ë§</h4>
        <p>{{ share_card.introduce or 'ì—†ìŒ' }}</p>
    </div>

    <!-- âœ… ë‚´ìš© -->
    <div class="content-box mt-3">
        <h4>ğŸ“„ ë‚´ìš©</h4>
        <p>{{ share_card.content }}</p>
    </div>

    <!-- âœ… ëª…í•¨ ì •ë³´ -->
    {% if namecard %}
    <div class="namecard-box mt-4 p-3 shadow-sm">
        <h4>ğŸ“Œ ëª…í•¨ ì •ë³´</h4>
        <div class="d-flex align-items-center">
            <!-- í”„ë¡œí•„ ì‚¬ì§„ -->
            <img src="{{ namecard.selected_photo or '/static/default_profile.jpg' }}" 
                 class="rounded-circle profile-img me-3">
            
            <div>
                <!-- ì´ë¦„ ë° ì§ê¸‰ -->
                <strong class="name-highlight">{{ namecard.username or 'ì´ë¦„ ì—†ìŒ' }}</strong> 
                ({{ namecard.position or 'ì§ê¸‰ ì—†ìŒ' }})<br>
                
                <!-- íšŒì‚¬ëª… -->
                ğŸ¢ {{ namecard.company or 'íšŒì‚¬ ì—†ìŒ' }}<br>
                
                <!-- ì´ë©”ì¼ -->
                ğŸ“§ <a href="mailto:{{ namecard.email }}" class="email-text">
                    {{ namecard.email or 'ì´ë©”ì¼ ì—†ìŒ' }}
                </a> <br>
                
                <!-- ìŠ¤ë§ˆíŠ¸í° ì „í™”ë²ˆí˜¸ -->
                ğŸ“± {{ namecard.phone or 'ì „í™” ì—†ìŒ' }} <br>
                
                <!-- ëŒ€í‘œ ì „í™” & ì§í†µ ì „í™” -->
                â˜ {{ namecard.tel_rep or 'ëŒ€í‘œë²ˆí˜¸ ì—†ìŒ' }} | ğŸ“ {{ namecard.tel_dir or 'ì§í†µë²ˆí˜¸ ì—†ìŒ' }} <br>

                <!-- íŒ©ìŠ¤ -->
                ğŸ“  {{ namecard.fax or 'íŒ©ìŠ¤ ì—†ìŒ' }}<br>

                <!-- ì£¼ì†Œ -->
                ğŸ“ {{ namecard.com_address or 'ì£¼ì†Œ ì—†ìŒ' }}<br>

                <!-- í™ˆí˜ì´ì§€ -->
                ğŸŒ <a href="http://{{ namecard.homepage }}" target="_blank">
                    {{ namecard.homepage or 'í™ˆí˜ì´ì§€ ì—†ìŒ' }}
                </a>
            </div>
        </div>
    </div>
   <!-- âœ… "ëª…í•¨ ë‚´ í°ì— ì €ì¥" ë²„íŠ¼ -->
   <div class="text-center mt-4">
        <button class="btn btn-success" onclick="saveToPhone('{{ namecard.id }}', '{{ welcome_data.unique_id }}', '{{ welcome_data.no }}')">
            ğŸ“¥ ëª…í•¨ ë‚´ í°ì— ì €ì¥
        </button>
    </div>
    {% else %}
        <p class="text-muted">ëª…í•¨ ì •ë³´ ì—†ìŒ</p>
    {% endif %}

        <!-- âœ… ê³µìœ ëœ íŒŒì¼ ë¦¬ìŠ¤íŠ¸ (ë‹¤ìš´ë¡œë“œ ë° ì²´í¬ ê¸°ëŠ¥ í¬í•¨) -->
        <div class="file-box mt-4 p-3 shadow-sm">
            <h4>ğŸ“‚ ê³µìœ í•  íŒŒì¼</h4>
            <ul class="file-list">
                {% set valid_files = share_card.s_file1, share_card.s_file2, share_card.s_file3, 
                                    share_card.s_file4, share_card.s_file5 %}
                {% set valid_files = valid_files | select('string') | reject('eq', '') | list %}
    
                {% if valid_files | length > 0 %}
                    {% for file in valid_files %}
                        <li>
                            <input type="checkbox" class="file-checkbox" value="{{ file }}">
                            <button class="btn btn-primary btn-sm me-2" onclick="downloadFile('{{ file }}')">â¬‡ï¸ ë‹¤ìš´ë¡œë“œ</button>
                            <span>{{ file }}</span>
                        </li>
                    {% endfor %}
                {% else %}
                    <p class="text-muted">ê³µìœ ëœ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                {% endif %}
            </ul>
        </div>
    
       <!-- âœ… ì´ë©”ì¼ ì…ë ¥ í•„ë“œ -->
    <div class="file-box mt-4 p-3 shadow-sm">
        <h4>ğŸ“§ ìˆ˜ì‹ ì ì´ë©”ì¼ ì¶”ê°€</h4>
        <div id="emailContainer">
            <div class="email-entry d-flex mb-2">
                <input type="email" class="form-control email-input me-2" placeholder="ì´ë©”ì¼ ì…ë ¥">
                <button class="btn btn-danger" onclick="this.parentNode.remove()">âŒ</button>
            </div>
        </div>
        <button id="addEmailButton" class="btn btn-secondary mt-2">â• ì´ë©”ì¼ ì¶”ê°€</button>
    </div>

    <!-- âœ… E-MAIL ë³´ë‚´ê¸° ë²„íŠ¼ -->
    <div class="text-center mt-4">
        <button class="btn btn-warning" onclick="sendEmail()">ì„ íƒí•œ íŒŒì¼ ë©”ì¼ ë°œì†¡</button>
    </div>


    <!-- âœ… ì‘ì„±ì¼ -->
    <p class="text-muted small">ğŸ“… ì‘ì„±ì¼: {{welcome_data.create_date or 'ë‚ ì§œ ì—†ìŒ' }}</p>
    


</div>
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="/static/e_css/e_sharecard.css">
{% endblock %}

{% block script %}
<script>
   function saveToPhone(namecardId, uniqueId, welcomeDataNo) {
    fetch('/enamecard/generate_vcard', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            namecard_id: namecardId,
            unique_id: uniqueId,
            welcome_data_no: welcomeDataNo
        })
    })
    .then(response => response.blob())
    .then(blob => {
        let url = window.URL.createObjectURL(blob);
        let a = document.createElement('a');
        a.href = url;

        let filename = `${namecardId}_contact.vcf`;
        a.download = filename;

        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);

        // âœ… URL í•´ì œ (ë©”ëª¨ë¦¬ ì •ë¦¬)
        setTimeout(() => {
            window.URL.revokeObjectURL(url);
        }, 1000);

        // âœ… ëª¨ë°”ì¼ í™˜ê²½ì—ì„œ ìë™ ì‹¤í–‰ ë°©ì§€ (ì¤‘ë³µ ë‹¤ìš´ë¡œë“œ ë°©ì§€)
        if (navigator.userAgent.match(/(iPhone|iPad|Android)/)) {
            setTimeout(() => {
                window.open(url, '_blank');
            }, 500);
        }
    })
    .catch(error => {
        console.error("Error:", error);
        alert("ëª…í•¨ ì €ì¥ ì¤‘ ì˜¤ë¥˜ ë°œìƒ");
    });
}

document.addEventListener("DOMContentLoaded", function () {
    // âœ… ì´ë©”ì¼ ë¦¬ìŠ¤íŠ¸ ë™ì  ì¶”ê°€/ì‚­ì œ ê¸°ëŠ¥
    const emailContainer = document.getElementById("emailContainer");
    const addEmailButton = document.getElementById("addEmailButton");

    addEmailButton.addEventListener("click", function () {
        const emailCount = document.querySelectorAll(".email-input").length;
        if (emailCount >= 5) {
            alert("ìµœëŒ€ 5ê°œì˜ ì´ë©”ì¼ì„ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
            return;
        }

        const emailDiv = document.createElement("div");
        emailDiv.classList.add("email-entry", "d-flex", "mb-2");
        
        const emailInput = document.createElement("input");
        emailInput.type = "email";
        emailInput.classList.add("form-control", "email-input", "me-2");
        emailInput.placeholder = "ì´ë©”ì¼ ì…ë ¥";

        const removeButton = document.createElement("button");
        removeButton.classList.add("btn", "btn-danger");
        removeButton.textContent = "âŒ";
        removeButton.addEventListener("click", function () {
            emailContainer.removeChild(emailDiv);
        });

        emailDiv.appendChild(emailInput);
        emailDiv.appendChild(removeButton);
        emailContainer.appendChild(emailDiv);
    });
});

// âœ… íŒŒì¼ ë‹¤ìš´ë¡œë“œ ê¸°ëŠ¥
function downloadFile(fileName) {
    window.location.href = '/enamecard/download_file/' + encodeURIComponent(fileName);
}

// âœ… ì´ë©”ì¼ ë³´ë‚´ê¸° ê¸°ëŠ¥ (ì„ íƒí•œ íŒŒì¼ & ì…ë ¥ëœ ì´ë©”ì¼)
function sendEmail() {
    let selectedFiles = [];
    document.querySelectorAll('.file-checkbox:checked').forEach(checkbox => {
        selectedFiles.push(checkbox.value);
    });

    if (selectedFiles.length === 0) {
        alert("ì „ì†¡í•  íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
        return;
    }

    let emailInputs = document.querySelectorAll(".email-input");
    let recipientEmails = [];

    emailInputs.forEach(input => {
        let email = input.value.trim();
        if (email) {
            if (!validateEmail(email)) {
                alert("ì˜ëª»ëœ ì´ë©”ì¼ í˜•ì‹: " + email);
                return;
            }
            recipientEmails.push(email);
        }
    });

    if (recipientEmails.length === 0) {
        alert("ìµœì†Œ 1ê°œ ì´ìƒì˜ ì´ë©”ì¼ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        return;
    }

    fetch('/enamecard/send_email', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            emails: recipientEmails,
            files: selectedFiles
        })
    })
    .then(response => response.json())
    .then(data => alert(data.message))
    .catch(error => console.error("Error:", error));
}

// âœ… ì´ë©”ì¼ í˜•ì‹ ê²€ì¦ í•¨ìˆ˜
function validateEmail(email) {
    const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return re.test(email);
}

</script>
{% endblock %}
